<%- include('../include/head') %>
<title>Shop Cart - Suresh kirana store</title>
<main>
	<!-- section-->
	<div class="mt-4">
		<div class="container">
			<!-- row -->
			<div class="row">
				<!-- col -->
				<div class="col-12">
					<!-- breadcrumb -->
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="#!">Home</a></li>
							<li class="breadcrumb-item"><a href="#!">Shop</a></li>
							<li class="breadcrumb-item active" aria-current="page">Shop Cart</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>
	</div>
	<!-- section -->
	<section class="mb-lg-14 mb-8 mt-8">
		<div class="container">
			<!-- row -->
			<div class="row">
				<div class="col-12">
					<!-- card -->
					<div class="card py-1 border-0 mb-8">
						<div>
							<h1 class="fw-bold">Shop Cart</h1>
							<p class="mb-0">Shopping in 274203</p>
						</div>
					</div>
				</div>
			</div>
			<!-- row -->
			<div class="row" id="full-div">
				<div class="col-lg-8 col-md-7">
					<div class="py-3">
						<!-- alert -->
						<!-- <div class="alert alert-danger p-2" role="alert">
									You’ve got FREE delivery. Start
									<a href="#!" class="alert-link">checkout now!</a>
								</div> -->
						<ul class="list-group list-group-flush ">

							<% 
							let totalprice = 0;
							let totalQuantity = 0;
							
							if (users && users.cart.length > 0) { %>
							<% users.cart.forEach(cartproduct => { %>
							<% product.forEach(productdata => { %>
							<% if (cartproduct.pid.toString() === productdata._id.toString()) { %>
								<% totalQuantity += cartproduct.quantity; %> <!-- Accumulate total quantity -->
															<% totalprice += (productdata.discounted_price*cartproduct.quantity); %>
							<li class="list-group-item py-3 ps-0  border-bottom">
								<!-- row -->
								<div class="row align-items-center">
									<div class="col-6 col-md-6 col-lg-7">
										<div class="d-flex">
											<img src="../upload/<%= productdata.image %>" alt="Product Image"
												class="icon-shape icon-xxl" />

											<div class="ms-3">
												<a href="#" class="text-inherit">
													<h6 class="mb-0"><%= productdata.name %>
													</h6>
												</a>
												<% categories.forEach(data => { %>
												<% if (data._id.toString() === productdata.category.toString()) { %>
												<span><small class="text-muted"><%= data.title %></small></span>

												<% } %>
												<% }); %>
												<!-- text -->
												<div class="mt-2 small lh-1">
													<a href="/removeFromCart/<%= productdata._id %>" class="text-decoration-none text-inherit remove-from-cart" data-product-id="<%= productdata._id %>">
														<span class="me-1 align-text-bottom">
															<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2 text-success">
																<polyline points="3 6 5 6 21 6"></polyline>
																<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
																<line x1="10" y1="11" x2="10" y2="17"></line>
																<line x1="14" y1="11" x2="14" y2="17"></line>
															</svg>
														</span>
														<span class="text-muted">Remove </span>
													</a>
												</div>												
											</div>
										</div>
									</div>
									<% quantity = cartproduct.quantity; %>

									<!-- input group -->
									<!-- Input group -->
									<div class="col-4 col-md-3 col-lg-3">
										<!-- Input spinner for quantity -->
										<div class="input-group input-spinner">
											<!-- Decrease quantity button -->
											<button type="button" class="button-minus btn btn-sm" data-action="decrement" data-productid="<%= productdata._id %>">-</button>
									
											<!-- Quantity input field -->
											<input type="number" min="1" max="30" value="<%= quantity %>" name="quantity" id="quantity_<%= productdata._id %>" class="quantity-field form-control-sm form-input" data-productid="<%= productdata._id %>" />
									
											<!-- Increase quantity button -->
											<button type="button" class="button-plus btn btn-sm" data-action="increment" data-productid="<%= productdata._id %>">+</button>
									
											<!-- Unit display -->
											<span class="form-control-sm fs-6">
												<% unit.forEach(unitdata => { %>
													<% if (unitdata._id.toString() === productdata.units.toString()) { %>
														<%= unitdata.name ? unitdata.name : ''; %>
													<% } %>
												<% }); %>
											</span>
										</div>
									</div>
									
									<script>
										document.addEventListener('DOMContentLoaded', () => {
											document.querySelectorAll('.input-spinner').forEach(inputSpinner => {
												inputSpinner.addEventListener('click', event => {
													const button = event.target.closest('button');
													if (!button) return;
									
													const quantityInput = inputSpinner.querySelector('.quantity-field');
													const action = button.dataset.action;
													const productId = button.dataset.productid;
													let currentQuantity = parseInt(quantityInput.value);
									
													if (action === 'increment') {
														if (currentQuantity < parseInt(quantityInput.max)) {
															currentQuantity++;
															showToast("Quantity Increased", "#4CAF50");
														} else {
															showToast("Maximum quantity reached", "#FF0000");
															return;
														}
													} else if (action === 'decrement') {
														if (currentQuantity > parseInt(quantityInput.min)) {
															currentQuantity--;
															showToast("Quantity Decreased", "#4CAF50");
														} else {
															showToast("Minimum quantity reached", "#FF0000");
															return;
														}
													}
									
													quantityInput.value = currentQuantity;
													console.log(`Current quantity of product ${productId} is ${currentQuantity} and it is ${action === 'increment' ? 'inc' : 'dec'} by 1`);
													
													updateQuantity(productId, currentQuantity);
												});
											});
										});
									
										let isRequestInProgress = false;
									
										function updateQuantity(productId, newQuantity) {
											if (isRequestInProgress) return;
									
											isRequestInProgress = true;
											console.log(`product id: ${productId} and quantity is ${newQuantity}`);
											
											$.ajax({
												url: '/updateCartQuantity',
												type: 'POST',
												data: {
													productId: productId,
													quantity: newQuantity
												},
												success: function(response) {
													console.log('Quantity updated successfully:', response);
													setTimeout(() => {
														location.reload();
													}, 4000);
												},
												error: function(xhr, status, error) {
													console.error('Error updating quantity:', error);
												},
												complete: function() {
													isRequestInProgress = false;
												}
											});
										}
								
									</script>
									
									

									



									<!-- price -->
									<div class="col-2 text-lg-end text-start text-md-end col-md-2">
										<span class="fw-bold text-danger">₹
											<%= productdata.discounted_price * quantity %>/-</span>
										<div class="text-decoration-line-through text-muted small">₹
											<%= productdata.price %></div>
									</div>
								</div>
							</li>
							<% } %>
							<% }); %>
							<% }); %>
							<% } else { %>
							<li class="list-group-item py-3 ps-0 border-bottom border-top text-center">No Item Added To
								Cart</li>
							<% } %>
						</ul>
						
					</div>
				</div>

				<!-- sidebar -->
				<div class="col-12 col-lg-4 col-md-5">
					<!-- card -->
					<div class="mb-5 card mt-6">
						<div class="card-body p-6">
							<!-- heading -->
							<h2 class="h5 mb-4">Summary</h2>
							<div class="card mb-2">
								<!-- list group -->
								<ul class="list-group list-group-flush">
									<!-- list group item -->
									<li class="list-group-item d-flex justify-content-between align-items-start">
										<div class="me-auto">
											<div>Item Subtotal</div>
										</div>
										<span>₹ <%= totalprice %></span>
									</li>

									<!-- list group item -->
									<li class="list-group-item d-flex justify-content-between align-items-start">
										<div class="me-auto">
											<div>Service Fee
												<i class="feather-icon icon-info text-muted" data-bs-toggle="tooltip"
													title="Platform Charges"></i>
											</div>
										</div>
										<span>₹ <%= setting[0].serviceFee %></span>

									</li>
									<li class="list-group-item d-flex justify-content-between align-items-start">
										<div class="me-auto">
											<div>Delivery Change
												<i class="feather-icon icon-info text-muted" data-bs-toggle="tooltip"
													title="Delivery Change apply below order of 299/-"></i>

											</div>
										</div>
										<%
											let deliveryCharges;
											if (totalprice > 299) {
												deliveryCharges = 0;
											} else {
												deliveryCharges = setting[0].deliveryCharges;
											}
											%>
											<span class="fw-bold">₹ <%= deliveryCharges %></span>
									</li>
									<!-- list group item -->
									<li class="list-group-item d-flex justify-content-between align-items-start">
										<div class="me-auto">
											<div class="fw-bold">Subtotal</div>
										</div>
										<span class="fw-bold">
											₹ <%= (parseFloat(totalprice) + parseFloat(deliveryCharges) + parseFloat(setting[0].serviceFee)).toFixed(2) %> /-
										</span>

									</li>
								</ul>
							</div>
							<div class="d-grid mb-1 mt-4">
								<!-- btn -->
								<a class="w-100" href="/shop-checkout">
									<button
										class="btn btn-primary btn-lg d-flex justify-content-between align-items-center w-100"
										type="submit">
										Go to Checkout
										<span class="fw-bold">₹ <%= (parseFloat(totalprice) + parseFloat(deliveryCharges) + parseFloat(setting[0].serviceFee)).toFixed(2) %> /-
										</span>
									</button>
								</a>
							</div>
							<!-- text -->
							<p>
								<small>
									By placing your order, you agree to be bound by the Suresh Kirana Store
									<a href="#!">Terms of Service</a>
									and
									<a href="#!">Privacy Policy.</a>
								</small>
							</p>

							<!-- heading -->
							<div class="mt-8" aria-disabled="true" disabled hidden>
								<h2 class="h5 mb-3">Add Promo or Gift Card</h2>
								<form>
									<div class="mb-2">
										<!-- input -->
										<label for="giftcard" class="form-label sr-only">Email address</label>
										<input type="text" class="form-control" id="giftcard"
											placeholder="Promo or Gift Card" />
									</div>
									<!-- btn -->
									<div class="d-grid"><button type="submit"
											class="btn btn-outline-dark mb-1">Redeem</button></div>
									<p class="text-muted mb-0"><small>Terms & Conditions apply</small></p>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
</main>
<script>
	document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.remove-from-cart').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const productId = this.dataset.productId;
            const url = `/removeFromCart/${productId}`;

            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Toastify({
                        text: "Product removed from cart successfully!",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#4CAF50",
                    }).showToast();

                    // Update the cart UI with the updated data
                    updateCartUI(data.updatedCart);

                    // Optionally, remove the item from the DOM
                    document.querySelector(`#product-${productId}`).remove();
					setTimeout(function() {
						window.location.reload();
					}, 3000);
                } else {
                    Toastify({
                        text: "Failed to remove product from cart: " + data.error,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#F44336",
                    }).showToast();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Toastify({
                    text: "Product removed from cart successfully!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#4CAF50",
                }).showToast();
            });
			setTimeout(function() {
				window.location.reload();
			}, 3000);
        });
    });
});

function updateCartUI(updatedCart) {
    // Example: Update the cart total quantity and total price
    document.querySelector('#cart-total-quantity').textContent = updatedCart.totalQuantity;
    document.querySelector('#cart-total-price').textContent = updatedCart.totalPrice;
    
    // Update other parts of the cart UI as needed
    // Example: If you have a cart item list, you can update it here
}

</script>
<script>
		
		function showToast(message, backgroundColor) {
											Toastify({
												text: message,
												duration: 3000,
												close: true,
												gravity: "top",
												position: "right",
												backgroundColor: backgroundColor,
											}).showToast();
										}
</script>



<%- include('../include/footer') %>